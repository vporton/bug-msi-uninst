<?xml version="1.0" encoding="UTF-8"?>
<?if $(env.ARCH) = x64 ?>
  <?define ProductName = "Uninstall Bug (64 bit)" ?>
  <?define Win64 = "yes" ?>
  <?define PlatformProgramFilesFolder = "ProgramFiles64Folder" ?>
<?else ?>
  <?define ProductName = "Uninstall Bug" ?>
  <?define Win64 = "no" ?>
  <?define PlatformProgramFilesFolder = "ProgramFilesFolder" ?>
<?endif ?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Id="1edc84cf-3a2b-4be9-ab5d-a1553c37e8ef" Name="Installer" Language="1033" Version="1.0.0.0" Manufacturer="Example" UpgradeCode="2a82c6fe-9e93-4ccd-8e6c-c04de9a8289b">
    <Package InstallerVersion="200" Compressed="yes" />

    <MediaTemplate EmbedCab="yes" />

    <Feature Id="ProductFeature" Title="Uninstall Bug" Level="1">
        <ComponentGroupRef Id="MyComponentGroupId" />
    </Feature>

    <Directory Id="TARGETDIR" Name="SourceDir">
        <Directory Id="$(var.PlatformProgramFilesFolder)">
            <Directory Id="INSTALLDIR" Name="Uninstall Bug" />
        </Directory>
    </Directory>

    <ComponentGroup Id="MyComponentGroupId">
        <Component Id="MyComponent" Directory="INSTALLDIR" Guid="dfb1e839-1f62-4613-b323-daa3166caab5" KeyPath="yes">
            <File Id="MainFile" Source="src/main.exe" />
            <?if Win64 = "yes" ?>
            <File Id="NSSMFIle" Source="distrib/nssm/win64/nssm.exe" />
            <?else ?>
            <File Id="NSSMFIle" Source="distrib/nssm/win32/nssm.exe" />
            <?endif ?>
        </Component>
    </ComponentGroup>

    <CustomAction Id="CreateService" Directory="INSTALLDIR" Execute="deferred" Impersonate="no"
    ExeCommand='"[INSTALLDIR]nssm" install XXXService "[MyProgramDir]main.exe" xxx' />
    <CustomAction Id="SetServiceDirectory" Directory="INSTALLDIR" Execute="deferred" Impersonate="no"
    ExeCommand='"[INSTALLDIR]nssm" set XXXService AppDirectory [src]' />
    <CustomAction Id="StartService" Directory="INSTALLDIR" Execute="deferred" Impersonate="no"
    ExeCommand='"[INSTALLDIR]nssm" start XXXService' />
    <CustomAction Id="StopService" Directory="INSTALLDIR" Execute="deferred" ExeCommand='"[INSTALLDIR]nssm" stop XXXService' Impersonate="no" Return="ignore" />
    <CustomAction Id="UninstallService" Directory="INSTALLDIR" Execute="deferred" ExeCommand='"[INSTALLDIR]nssm" remove XXXService confirm' Impersonate="no" Return="ignore" />
    <InstallExecuteSequence>
        <Custom Action="CreateService" After="InstallServices" />
        <Custom Action="SetServiceDirectory" After="InstallServices" />
        <Custom Action="StartService" After="StartServices" />
        <Custom Action="UninstallService" Before="DeleteServices" />
        <Custom Action="StopService" Before="StopServices" />
    </InstallExecuteSequence>
  </Product>
</Wix>